trigger: none

# Pipeline Parameters for selective deployment
parameters:
  - name: targetEnvironment
    displayName: 'Deploy to Environment'
    type: string
    default: 'UAT'
    values:
      - 'DEV'
      - 'UAT'
      - 'PROD'

  - name: deploymentMode
    displayName: 'Deployment Mode'
    type: string
    default: 'SELECTIVE'
    values:
      - 'ALL'        # Deploy all reports
      - 'SELECTIVE'  # Deploy only specified reports

  - name: reportNames
    displayName: 'Report Names (comma-separated, e.g: Sales1,Sales5,Sales10)'
    type: string
    default: 'Sales Dashboard 2'

  - name: autoDetectChanges
    displayName: 'Auto-detect changed reports from Git?'
    type: boolean
    default: false

pool:
  vmImage: 'windows-latest'

variables:
  TenantId: 'e4d98dd2-9199-42e5-ba8b-da3e763ede2e'
  ClientId: 'dd3aa383-4d69-4854-8885-9e483ffb5b72'
  ClientSecret: '82H8Q~TuZnTU9XRytWpK46g.YP_QoTTUww-NWday'
  BaseFolder: '$(Build.SourcesDirectory)\Sales'
  
  # Environment Configuration
  DevWorkspaceId: 'b42dfb7f-667e-48f9-97c9-12198c700e09'
  DevWorkspaceName: 'VISACICDDev'
  DevSharePointUrl: 'https://testmaq.sharepoint.com/sites/VisaTest/Shared%20Documents/Dev/SalesDashboard.xlsx'
  DevGatewayId: 'fabd7e5d-1737-4c50-88c0-7ec4874f99e5'
  
  UatWorkspaceId: '436d60a0-3a50-480d-b7e5-f7a9d3cd5fb5'
  UatWorkspaceName: 'VISACICDQA'
  UatSharePointUrl: 'https://testmaq.sharepoint.com/sites/VisaTest/Shared%20Documents/Uat/SalesDashboard.xlsx'
  UatGatewayId: 'd91d80d8-19e2-4959-af4b-74d40bde50d8'
  
  ProdWorkspaceId: 'cb0a4bb8-e16a-4886-b803-4dcceda22cd0'
  ProdWorkspaceName: 'VISACICDProd'
  ProdSharePointUrl: 'https://testmaq.sharepoint.com/sites/VisaTest/Shared%20Documents/Prod/SalesDashboard.xlsx'
  ProdGatewayId: '757a32db-a93c-4516-9f43-da8968e99aac'

steps:
  - task: PowerShell@2
    displayName: 'üéØ Selective Report Deployment'
    inputs:
      targetType: 'inline'
      pwsh: true
      script: |
        $ErrorActionPreference = "Stop"

        # ===== DEPLOYMENT PARAMETERS =====
        $TargetEnvironment = "${{ parameters.targetEnvironment }}"
        $DeploymentMode = "${{ parameters.deploymentMode }}"
        $ReportNamesInput = "${{ parameters.reportNames }}"
        $AutoDetectChanges = [System.Convert]::ToBoolean("${{ parameters.autoDetectChanges }}")
        
        Write-Host "üöÄ SELECTIVE REPORT DEPLOYMENT PIPELINE" -ForegroundColor Cyan
        Write-Host "=" * 60 -ForegroundColor Cyan
        Write-Host "üéØ Target Environment: $TargetEnvironment" -ForegroundColor White
        Write-Host "üîÑ Deployment Mode: $DeploymentMode" -ForegroundColor White
        Write-Host "üìù Auto-detect Changes: $AutoDetectChanges" -ForegroundColor White
        Write-Host "üìã Report Names Input: '$ReportNamesInput'" -ForegroundColor White
        Write-Host "=" * 60 -ForegroundColor Cyan
        Write-Host ""

        # ===== ENVIRONMENT CONFIGURATION =====
        switch ($TargetEnvironment.ToUpper().Trim()) {
            "DEV" {
                $EnvironmentType = "DEVELOPMENT"
                $WorkspaceId = "$(DevWorkspaceId)"
                $WorkspaceName = "$(DevWorkspaceName)"
                $TargetSharePointUrl = "$(DevSharePointUrl)"
                $TargetGatewayId = "$(DevGatewayId)"
                $DisplayColor = "Green"
            }
            "UAT" {
                $EnvironmentType = "UAT"
                $WorkspaceId = "$(UatWorkspaceId)"
                $WorkspaceName = "$(UatWorkspaceName)"
                $TargetSharePointUrl = "$(UatSharePointUrl)"
                $TargetGatewayId = "$(UatGatewayId)"
                $DisplayColor = "Yellow"
            }
            "PROD" {
                $EnvironmentType = "PRODUCTION"
                $WorkspaceId = "$(ProdWorkspaceId)"
                $WorkspaceName = "$(ProdWorkspaceName)"
                $TargetSharePointUrl = "$(ProdSharePointUrl)"
                $TargetGatewayId = "$(ProdGatewayId)"
                $DisplayColor = "Red"
                
                Write-Host "‚ö†Ô∏è  WARNING: DEPLOYING TO PRODUCTION ENVIRONMENT!" -ForegroundColor Red
                Write-Host "üî¥ This will affect live production data!" -ForegroundColor Red
            }
            default {
                Write-Error "‚ùå Invalid target environment: '$TargetEnvironment'"
                exit 1
            }
        }

        Write-Host "üè¢ Target Workspace: $WorkspaceName ($WorkspaceId)" -ForegroundColor $DisplayColor
        Write-Host ""

        # ===== DISCOVER AVAILABLE REPORTS =====
        $pbipFolder = "$(BaseFolder)"
        Write-Host "üîç Discovering available reports in: $pbipFolder"

        if (!(Test-Path $pbipFolder)) {
            Write-Error "‚ùå Base folder not found: $pbipFolder"
            exit 1
        }

        # Find all .SemanticModel and .Report folders
        $allSemanticModels = Get-ChildItem -Path $pbipFolder -Directory | Where-Object { $_.Name -like "*.SemanticModel" }
        $allReports = Get-ChildItem -Path $pbipFolder -Directory | Where-Object { $_.Name -like "*.Report" }

        $availableProjects = @()
        foreach ($sm in $allSemanticModels) {
            $projectBaseName = $sm.Name -replace '\.SemanticModel$', ''
            $correspondingReport = $allReports | Where-Object { $_.Name -eq "$projectBaseName.Report" }
            
            if ($correspondingReport) {
                $availableProjects += @{
                    Name = $projectBaseName
                    SemanticModelPath = $sm.FullName
                    ReportPath = $correspondingReport.FullName
                }
            }
        }

        Write-Host "üìä Found $($availableProjects.Count) complete Power BI projects:" -ForegroundColor Cyan
        foreach ($project in $availableProjects) {
            Write-Host "   ‚Ä¢ $($project.Name)" -ForegroundColor White
        }
        Write-Host ""

        if ($availableProjects.Count -eq 0) {
            Write-Error "‚ùå No complete Power BI projects found (need both .SemanticModel and .Report folders)"
            exit 1
        }

        # ===== DETERMINE WHICH REPORTS TO DEPLOY =====
        $reportsToDeployList = @()

        if ($DeploymentMode -eq "ALL") {
            Write-Host "üìã DEPLOY ALL MODE: Deploying all $($availableProjects.Count) reports" -ForegroundColor Cyan
            $reportsToDeployList = $availableProjects
        }
        elseif ($AutoDetectChanges) {
            Write-Host "üîç AUTO-DETECT MODE: Analyzing Git changes..." -ForegroundColor Cyan
            
            try {
                # Get changed files in the last commit or compare with main branch
                $changedFiles = @()
                
                # Try to get files changed in current commit vs previous
                try {
                    $changedFiles = git diff --name-only HEAD~1 HEAD 2>$null
                } catch {
                    # Fallback: get all files changed vs main/master
                    try {
                        $changedFiles = git diff --name-only origin/main HEAD 2>$null
                    } catch {
                        try {
                            $changedFiles = git diff --name-only origin/master HEAD 2>$null
                        } catch {
                            Write-Warning "‚ö†Ô∏è Could not detect Git changes, falling back to manual selection"
                            $changedFiles = @()
                        }
                    }
                }
                
                if ($changedFiles.Count -gt 0) {
                    Write-Host "üìù Found $($changedFiles.Count) changed files:"
                    $changedFiles | ForEach-Object { Write-Host "   ‚Ä¢ $_" -ForegroundColor Gray }
                    
                    # Find which projects have changes
                    $changedProjects = @()
                    foreach ($project in $availableProjects) {
                        $hasChanges = $false
                        foreach ($file in $changedFiles) {
                            if ($file -like "*$($project.Name)*") {
                                $hasChanges = $true
                                break
                            }
                        }
                        if ($hasChanges) {
                            $changedProjects += $project
                        }
                    }
                    
                    if ($changedProjects.Count -gt 0) {
                        Write-Host "üéØ Auto-detected $($changedProjects.Count) changed projects:" -ForegroundColor Green
                        foreach ($project in $changedProjects) {
                            Write-Host "   ‚úÖ $($project.Name)" -ForegroundColor Green
                        }
                        $reportsToDeployList = $changedProjects
                    } else {
                        Write-Host "‚ÑπÔ∏è No Power BI projects detected in changed files" -ForegroundColor Yellow
                    }
                } else {
                    Write-Host "‚ÑπÔ∏è No changed files detected" -ForegroundColor Yellow
                }
            } catch {
                Write-Warning "‚ö†Ô∏è Git auto-detection failed: $($_.Exception.Message)"
            }
        }
        
        # Manual selection (either as primary mode or fallback)
        if ($DeploymentMode -eq "SELECTIVE" -or ($AutoDetectChanges -and $reportsToDeployList.Count -eq 0)) {
            Write-Host "üìù SELECTIVE MODE: Manual report selection" -ForegroundColor Cyan
            
            if ([string]::IsNullOrWhiteSpace($ReportNamesInput)) {
                Write-Host ""
                Write-Host "‚ùå No reports specified for selective deployment!" -ForegroundColor Red
                Write-Host ""
                Write-Host "üí° AVAILABLE OPTIONS:" -ForegroundColor Cyan
                Write-Host "   1. Specify reports in 'Report Names' parameter:" -ForegroundColor White
                foreach ($project in $availableProjects) {
                    Write-Host "      ‚Ä¢ $($project.Name)" -ForegroundColor Gray
                }
                Write-Host ""
                Write-Host "   2. Example: Sales1,Sales5,Sales10" -ForegroundColor Yellow
                Write-Host "   3. Or change Deployment Mode to 'ALL'" -ForegroundColor Yellow
                Write-Host "   4. Or enable 'Auto-detect changed reports'" -ForegroundColor Yellow
                exit 1
            }
            
            # Parse report names
            $requestedReports = $ReportNamesInput -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne '' }
            
            Write-Host "üìã Requested reports: $($requestedReports -join ', ')" -ForegroundColor White
            
            # Validate and find matching projects
            $foundReports = @()
            $missingReports = @()
            
            foreach ($reportName in $requestedReports) {
                $matchedProject = $availableProjects | Where-Object { $_.Name -eq $reportName }
                if ($matchedProject) {
                    $foundReports += $matchedProject
                    Write-Host "   ‚úÖ $reportName - Found" -ForegroundColor Green
                } else {
                    $missingReports += $reportName
                    Write-Host "   ‚ùå $reportName - Not Found" -ForegroundColor Red
                }
            }
            
            if ($missingReports.Count -gt 0) {
                Write-Host ""
                Write-Host "‚ùå Missing reports: $($missingReports -join ', ')" -ForegroundColor Red
                Write-Host "üí° Available reports:" -ForegroundColor Cyan
                foreach ($project in $availableProjects) {
                    Write-Host "   ‚Ä¢ $($project.Name)" -ForegroundColor White
                }
                exit 1
            }
            
            $reportsToDeployList = $foundReports
        }

        # Final validation
        if ($reportsToDeployList.Count -eq 0) {
            Write-Host "‚ùå No reports selected for deployment!" -ForegroundColor Red
            exit 1
        }

        Write-Host ""
        Write-Host "üöÄ DEPLOYMENT SUMMARY" -ForegroundColor Cyan
        Write-Host "=" * 50 -ForegroundColor Cyan
        Write-Host "üìä Reports to deploy: $($reportsToDeployList.Count)" -ForegroundColor $DisplayColor
        foreach ($report in $reportsToDeployList) {
            Write-Host "   ‚Ä¢ $($report.Name)" -ForegroundColor $DisplayColor
        }
        Write-Host "üéØ Target: $EnvironmentType ($WorkspaceName)" -ForegroundColor $DisplayColor
        Write-Host "=" * 50 -ForegroundColor Cyan
        Write-Host ""

        # ===== AUTHENTICATION =====
        Write-Host "üîê Authenticating with Fabric API..."
        
        $currentPath = (Split-Path $MyInvocation.MyCommand.Definition -Parent)
        Set-Location $currentPath

        $moduleFolder = ".\module"
        New-Item -ItemType Directory -Path $moduleFolder -ErrorAction SilentlyContinue | Out-Null

        @(
            "https://raw.githubusercontent.com/microsoft/Analysis-Services/master/pbidevmode/fabricps-pbip/FabricPS-PBIP.psm1",
            "https://raw.githubusercontent.com/microsoft/Analysis-Services/master/pbidevmode/fabricps-pbip/FabricPS-PBIP.psd1"
        ) | ForEach-Object {
            $file = Split-Path $_ -Leaf
            Invoke-WebRequest -Uri $_ -OutFile (Join-Path $moduleFolder $file) -UseBasicParsing
        }

        Import-Module Az.Accounts -Force
        Import-Module (Join-Path $moduleFolder "FabricPS-PBIP.psd1") -Force

        Set-FabricAuthToken `
          -servicePrincipalId "$(ClientId)" `
          -servicePrincipalSecret "$(ClientSecret)" `
          -tenantId "$(TenantId)" `
          -reset

        # Get REST API access token
        $body = @{
            grant_type    = "client_credentials"
            client_id     = "$(ClientId)"
            client_secret = "$(ClientSecret)"
            scope         = "https://analysis.windows.net/powerbi/api/.default"
        }
        $tokenResponse = Invoke-RestMethod -Uri "https://login.microsoftonline.com/$(TenantId)/oauth2/v2.0/token" `
            -Method POST -Body $body
        $accessToken = $tokenResponse.access_token

        # ===== PRE-DEPLOYMENT VALIDATION =====
        Write-Host "üîç Pre-deployment validation..." -ForegroundColor Cyan

        # Test SharePoint URL accessibility
        Write-Host "üåê Testing SharePoint URL accessibility..." -ForegroundColor White
        try {
            $headers = @{ "Authorization" = "Bearer $accessToken" }
            $testResponse = Invoke-WebRequest -Uri $TargetSharePointUrl -Headers $headers -Method Head -UseBasicParsing
            Write-Host "   ‚úÖ SharePoint URL accessible (Status: $($testResponse.StatusCode))" -ForegroundColor Green
        } catch {
            Write-Warning "   ‚ö†Ô∏è SharePoint URL test failed: $($_.Exception.Message)"
            Write-Host "   üìù This might cause dataset import issues" -ForegroundColor Yellow
        }

        # Validate workspace access
        Write-Host "üè¢ Validating workspace access..." -ForegroundColor White
        try {
            $workspaceUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId"
            $workspace = Invoke-RestMethod -Uri $workspaceUrl -Headers @{ "Authorization" = "Bearer $accessToken" }
            Write-Host "   ‚úÖ Workspace accessible: $($workspace.name)" -ForegroundColor Green
        } catch {
            Write-Error "   ‚ùå Cannot access workspace: $($_.Exception.Message)"
            exit 1
        }

        # ===== DEPLOY SELECTED REPORTS =====
        $successfulDeployments = @()
        $failedDeployments = @()

        foreach ($project in $reportsToDeployList) {
            Write-Host ""
            Write-Host "üöÄ Deploying: $($project.Name)" -ForegroundColor Cyan
            Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
            
            try {
                # Validate PBIP structure
                Write-Host "üìã Validating PBIP structure..." -ForegroundColor White
                
                $definitionJson = Join-Path $project.SemanticModelPath "definition.pbidataset"
                $reportJson = Join-Path $project.ReportPath "definition.pbireport"
                
                if (!(Test-Path $definitionJson)) {
                    throw "Missing definition.pbidataset in SemanticModel folder"
                }
                if (!(Test-Path $reportJson)) {
                    throw "Missing definition.pbireport in Report folder"
                }
                
                Write-Host "   ‚úÖ PBIP structure validated" -ForegroundColor Green

                # Import Semantic Model with enhanced monitoring
                Write-Host "üì• Importing Semantic Model..." -ForegroundColor White
                
                $importStartTime = Get-Date
                $semanticModelImport = $null
                
                try {
                    $semanticModelImport = Import-FabricItem -workspaceId $WorkspaceId -path $project.SemanticModelPath
                    Write-Host "   ‚úÖ Semantic Model imported successfully" -ForegroundColor Green
                    Write-Host "   üìä Semantic Model ID: $($semanticModelImport.Id)" -ForegroundColor Green
                } catch {
                    $importError = $_.Exception.Message
                    Write-Host "   ‚ùå Semantic Model import failed: $importError" -ForegroundColor Red
                    
                    # Enhanced error analysis
                    if ($importError -like "*Dataset_Import_FailedToImportDataset*") {
                        Write-Host "   üîç ANALYSIS: Dataset import failed - likely causes:" -ForegroundColor Yellow
                        Write-Host "      ‚Ä¢ Data source connectivity issues" -ForegroundColor Yellow
                        Write-Host "      ‚Ä¢ Authentication/permission problems" -ForegroundColor Yellow
                        Write-Host "      ‚Ä¢ Invalid data structure or schema" -ForegroundColor Yellow
                        Write-Host "      ‚Ä¢ SharePoint file not accessible or corrupted" -ForegroundColor Yellow
                        
                        # Check if we can read the dataset definition
                        try {
                            $datasetDef = Get-Content $definitionJson -Raw | ConvertFrom-Json
                            Write-Host "   üìã Dataset definition contains:" -ForegroundColor Gray
                            if ($datasetDef.model.dataSources) {
                                foreach ($ds in $datasetDef.model.dataSources) {
                                    Write-Host "      ‚Ä¢ DataSource: $($ds.type) - $($ds.connectionDetails.address)" -ForegroundColor Gray
                                }
                            }
                        } catch {
                            Write-Host "   ‚ö†Ô∏è Could not read dataset definition for analysis" -ForegroundColor Yellow
                        }
                    }
                    
                    throw $importError
                }

                # Wait for dataset to be fully available before proceeding
                Write-Host "‚è≥ Waiting for dataset to be available..." -ForegroundColor White
                $maxWaitTime = 300 # 5 minutes
                $waitInterval = 10
                $totalWaited = 0
                
                do {
                    Start-Sleep -Seconds $waitInterval
                    $totalWaited += $waitInterval
                    
                    try {
                        $datasetUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)"
                        $dataset = Invoke-RestMethod -Uri $datasetUrl -Headers @{ "Authorization" = "Bearer $accessToken" }
                        
                        if ($dataset -and $dataset.id) {
                            Write-Host "   ‚úÖ Dataset is available and ready" -ForegroundColor Green
                            break
                        }
                    } catch {
                        if ($totalWaited -ge $maxWaitTime) {
                            throw "Dataset did not become available within $maxWaitTime seconds"
                        }
                        Write-Host "   ‚è≥ Still waiting... ($totalWaited/$maxWaitTime seconds)" -ForegroundColor Gray
                    }
                } while ($totalWaited -lt $maxWaitTime)

                # Configure datasources BEFORE importing report
                Write-Host "üîó Configuring datasources..." -ForegroundColor White
                $datasourcesUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)/datasources"
                
                try {
                    $datasources = Invoke-RestMethod -Uri $datasourcesUrl -Method GET -Headers @{
                        "Authorization" = "Bearer $accessToken"
                    }
                    
                    $sharePointDatasources = $datasources.value | Where-Object { 
                        $_.datasourceType -in @("SharePointList", "SharePointFolder", "SharePointOnlineList") 
                    }
                    
                    if ($sharePointDatasources.Count -gt 0) {
                        Write-Host "   üîÑ Updating $($sharePointDatasources.Count) SharePoint datasource(s)..." -ForegroundColor White
                        
                        # Update datasources one by one
                        foreach ($spDs in $sharePointDatasources) {
                            try {
                                # Use the takeover approach for better reliability
                                $takeoverUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)/Default.TakeOver"
                                
                                Invoke-RestMethod -Uri $takeoverUrl -Method POST -Headers @{
                                    "Authorization" = "Bearer $accessToken"
                                    "Content-Type" = "application/json"
                                }
                                
                                Write-Host "      ‚úÖ Dataset ownership taken over" -ForegroundColor Green
                                
                                # Now update the datasource
                                $updateUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)/Default.UpdateDatasources"
                                
                                $updateBody = @{
                                    updateDetails = @(
                                        @{
                                            datasourceSelector = @{
                                                datasourceType = $spDs.datasourceType
                                                connectionDetails = $spDs.connectionDetails
                                            }
                                            connectionDetails = @{ 
                                                url = $TargetSharePointUrl 
                                            }
                                            credentialDetails = @{
                                                credentialType = "OAuth2"
                                                credentials = $accessToken
                                                privacyLevel = "Organizational"
                                            }
                                        }
                                    )
                                } | ConvertTo-Json -Depth 10

                                Invoke-RestMethod -Uri $updateUrl -Method POST -Headers @{
                                    "Authorization" = "Bearer $accessToken"
                                    "Content-Type" = "application/json"
                                } -Body $updateBody
                                
                                Write-Host "      ‚úÖ Datasource updated: $($spDs.datasourceType)" -ForegroundColor Green
                                
                            } catch {
                                Write-Warning "      ‚ö†Ô∏è Datasource update failed: $($_.Exception.Message)"
                                # Continue with other datasources
                            }
                        }
                        
                        # Gateway binding (if configured)
                        if ($TargetGatewayId -and $TargetGatewayId -ne "" -and $TargetGatewayId -notlike "*your-*-gateway-id-here*") {
                            Write-Host "   üåê Binding to gateway..." -ForegroundColor White
                            try {
                                $gatewayBindUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)/Default.BindToGateway"
                                $gatewayBindBody = @{
                                    gatewayObjectId = $TargetGatewayId
                                } | ConvertTo-Json

                                Invoke-RestMethod -Uri $gatewayBindUrl -Method POST -Headers @{
                                    "Authorization" = "Bearer $accessToken"
                                    "Content-Type" = "application/json"
                                } -Body $gatewayBindBody
                                
                                Write-Host "      ‚úÖ Gateway binding successful" -ForegroundColor Green
                            } catch {
                                Write-Warning "      ‚ö†Ô∏è Gateway binding failed: $($_.Exception.Message)"
                            }
                        }
                        
                    } else {
                        Write-Host "   üìã No SharePoint datasources to configure" -ForegroundColor Gray
                    }
                } catch {
                    Write-Warning "   ‚ö†Ô∏è Could not configure datasources: $($_.Exception.Message)"
                }

                # Test data refresh before importing report
                Write-Host "üîÑ Testing dataset refresh..." -ForegroundColor White
                try {
                    $refreshUrl = "https://api.powerbi.com/v1.0/myorg/groups/$WorkspaceId/datasets/$($semanticModelImport.Id)/refreshes"
                    
                    # Start refresh
                    Invoke-RestMethod -Uri $refreshUrl -Method POST -Headers @{
                        "Authorization" = "Bearer $accessToken"
                        "Content-Type" = "application/json"
                    }
                    
                    # Monitor refresh status
                    $refreshWaitTime = 0
                    $maxRefreshWait = 120 # 2 minutes for initial test
                    
                    do {
                        Start-Sleep -Seconds 10
                        $refreshWaitTime += 10
                        
                        $refreshStatus = Invoke-RestMethod -Uri $refreshUrl -Headers @{ "Authorization" = "Bearer $accessToken" }
                        $latestRefresh = $refreshStatus.value | Select-Object -First 1
                        
                        if ($latestRefresh.status -eq "Completed") {
                            Write-Host "   ‚úÖ Dataset refresh completed successfully" -ForegroundColor Green
                            break
                        } elseif ($latestRefresh.status -eq "Failed") {
                            throw "Dataset refresh failed: $($latestRefresh.serviceExceptionJson)"
                        }
                        
                        Write-Host "   ‚è≥ Refresh in progress... ($refreshWaitTime/$maxRefreshWait seconds)" -ForegroundColor Gray
                        
                    } while ($refreshWaitTime -lt $maxRefreshWait -and $latestRefresh.status -eq "Unknown")
                    
                    if ($latestRefresh.status -ne "Completed" -and $refreshWaitTime -ge $maxRefreshWait) {
                        Write-Warning "   ‚ö†Ô∏è Refresh is taking longer than expected, proceeding with report import"
                    }
                    
                } catch {
                    Write-Warning "   ‚ö†Ô∏è Dataset refresh test failed: $($_.Exception.Message)"
                    Write-Host "   üìù Proceeding with report import, but data may not be current" -ForegroundColor Yellow
                }

                # Import Report
                Write-Host "üìÑ Importing Report and binding to Semantic Model..." -ForegroundColor White
                try {
                    $reportImport = Import-FabricItem -workspaceId $WorkspaceId -path $project.ReportPath -itemProperties @{
                        "semanticModelId" = $semanticModelImport.Id
                    }
                    Write-Host "   ‚úÖ Report imported successfully" -ForegroundColor Green
                    Write-Host "   üìä Report ID: $($reportImport.Id)" -ForegroundColor Green
                } catch {
                    Write-Warning "   ‚ö†Ô∏è Report import failed: $($_.Exception.Message)"
                    Write-Host "   üìù Semantic model was imported successfully, you can manually create the report" -ForegroundColor Yellow
                    # Don't throw here, partial success is still valuable
                }

                $successfulDeployments += $project.Name
                Write-Host "‚úÖ $($project.Name) - DEPLOYMENT SUCCESSFUL" -ForegroundColor Green

            } catch {
                $failedDeployments += @{
                    Name = $project.Name
                    Error = $_.Exception.Message
                }
                Write-Host "‚ùå $($project.Name) - DEPLOYMENT FAILED: $($_.Exception.Message)" -ForegroundColor Red
                
                # Additional troubleshooting info
                Write-Host "üîç TROUBLESHOOTING STEPS:" -ForegroundColor Yellow
                Write-Host "   1. Verify SharePoint file exists and is accessible: $TargetSharePointUrl" -ForegroundColor Yellow
                Write-Host "   2. Check service principal permissions on SharePoint site" -ForegroundColor Yellow
                Write-Host "   3. Ensure workspace has proper permissions for the service principal